<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thống kê - Ergoffice Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar { height: 100vh; background: #2c3e50; color: white; position: fixed; width: 250px; }
        .sidebar a { color: #adb5bd; text-decoration: none; display: block; padding: 10px 20px; }
        .sidebar a:hover, .sidebar a.active { background: #34495e; color: white; }
        .main-content { margin-left: 250px; padding: 20px; }
        .stat-card { border-radius: 10px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: white;}
        .stat-icon { font-size: 2.5rem; opacity: 0.8; }
        .stat-value { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>

<div th:replace="~{admin/fragments/sidebar :: sidebar(current='stats')}"></div>

<div class="main-content">
    <div class="container-fluid">
        <h2 class="mb-4">Báo Cáo Thống Kê</h2>
        
        <!-- Summary Cards -->
        <div class="row mb-5">
            <div class="col-md-6 mb-4">
                <div class="card stat-card bg-primary p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Tổng Doanh Thu</h5>
                            <div class="stat-value" th:text="${#numbers.formatDecimal(revenue, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</div>
                            <small>Đơn hàng đã hoàn thành</small>
                        </div>
                        <i class="fas fa-money-bill-wave stat-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card stat-card bg-success p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Đơn Hàng Thành Công</h5>
                            <div class="stat-value" th:text="${orders}">0</div>
                            <small>Tổng số đơn đã giao</small>
                        </div>
                        <i class="fas fa-shopping-bag stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Products Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-primary fw-bold"><i class="fas fa-trophy text-warning me-2"></i>Top 10 Sản Phẩm Bán Chạy</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Tên Sản Phẩm</th>
                            <th class="text-center">Số Lượng Đã Bán</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="p, iter : ${topProducts}">
                            <td th:text="${iter.count}" class="fw-bold text-secondary">1</td>
                            <td th:text="${p.productName}">Product Name</td>
                            <td th:text="${p.quantity}" class="text-center fw-bold text-primary">100</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(topProducts)}">
                            <td colspan="3" class="text-center py-4 text-muted">Chưa có dữ liệu thống kê</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="row mt-5">
            <div class="col-md-8 mb-4">
                <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4"><i class="fas fa-chart-line text-primary me-2"></i>Xu hướng doanh thu</h5>
                        <div style="height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4"><i class="fas fa-chart-pie text-success me-2"></i>Trạng thái đơn hàng</h5>
                        <div style="height: 300px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4"><i class="fas fa-trophy text-warning me-2"></i>Top sản phẩm bán chạy</h5>
                        <div style="height: 350px;">
                            <canvas id="productsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script th:inline="javascript">
    // Revenue Trend Chart - using real monthly data from backend
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const monthlyRevenueData = /*[[${monthlyRevenue}]]*/ {};
    
    console.log('Raw monthlyRevenue:', monthlyRevenueData);
    
    const revenueLabels = Object.keys(monthlyRevenueData);
    const revenueValues = Object.values(monthlyRevenueData);
    
    console.log('Revenue Data:', monthlyRevenueData);
    console.log('Revenue Labels:', revenueLabels);
    console.log('Revenue Values:', revenueValues);
    
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: revenueLabels,
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: revenueValues,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1f2937',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const value = Math.floor(context.parsed.y);
                            return new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: Math.max(...revenueValues) * 1.1,
                    ticks: {
                        callback: function(value) {
                            if (value === 0) return '0';
                            if (value < 1000000) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                            return (value / 1000000).toFixed(1) + 'M';
                        }
                    },
                    grid: { color: '#f3f4f6' }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // Order Status Chart - using real data
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusMapData = /*[[${statusMap}]]*/ {};
    
    console.log('Raw statusMap:', statusMapData);
    
    // Map status names to Vietnamese labels and prepare chart data
    const statusLabels = Object.keys(statusMapData);
    const statusValues = Object.values(statusMapData);
    
    console.log('Status Data:', statusMapData);
    console.log('Status Labels:', statusLabels);
    console.log('Status Values:', statusValues);
    
    const statusColors = {
        'Hoàn thành': '#10b981',
        'Đang xử lý': '#f59e0b',
        'Đã hủy': '#ef4444',
        'Đang giao': '#3b82f6'
    };
    
    const chartColors = statusLabels.map(status => statusColors[status] || '#6b7280');
    
    if (statusLabels.length > 0) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: chartColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + ' đơn';
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('statusChart').parentElement.innerHTML = '<p class="text-center text-muted py-5">Chưa có dữ liệu</p>';
    }

    // Top Products Chart - using real data
    const productsCtx = document.getElementById('productsChart').getContext('2d');
    const topProductsData = /*[[${topProducts}]]*/ [];
    
    console.log('Raw topProducts:', topProductsData);
    
    if (topProductsData && topProductsData.length > 0) {
        const productNames = topProductsData.map(p => p.productName && p.productName.length > 25 ? p.productName.substring(0, 25) + '...' : (p.productName || 'Unknown'));
        const productSales = topProductsData.map(p => p.quantity || 0);
        
        console.log('Product Names:', productNames);
        console.log('Product Sales:', productSales);
        
        new Chart(productsCtx, {
            type: 'bar',
            data: {
                labels: productNames,
                datasets: [{
                    label: 'Số lượng bán',
                    data: productSales,
                    backgroundColor: [
                        '#4f46e5',
                        '#7c3aed',
                        '#ec4899',
                        '#f59e0b',
                        '#10b981',
                        '#06b6d4',
                        '#8b5cf6',
                        '#f97316',
                        '#14b8a6',
                        '#6366f1'
                    ],
                    borderRadius: 8,
                    barThickness: 40
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Bán: ' + context.parsed.x + ' sản phẩm';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6' }
                    },
                    y: { grid: { display: false } }
                }
            }
        });
    } else {
        console.log('No product data found');
        document.getElementById('productsChart').parentElement.innerHTML = '<p class="text-center text-muted py-5">Chưa có dữ liệu sản phẩm bán chạy</p>';
    }
</script>
</body>
</html>
