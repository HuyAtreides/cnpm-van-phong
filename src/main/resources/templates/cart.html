<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè H√†ng - Ergoffice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <div th:replace="~{fragments/navigation :: user-menu-styles}"></div>
</head>
<body>

<div th:replace="~{fragments/navigation :: navigation}"></div>

<div class="cart-page">
    <div class="container">
        <div class="cart-header">
            <h1>üõí Gi·ªè H√†ng C·ªßa B·∫°n</h1>
            <p th:if="${!#lists.isEmpty(cartItems)}" class="cart-item-count">
                <span th:text="${#lists.size(cartItems)}">0</span> s·∫£n ph·∫©m
            </p>
        </div>

        
        <div th:if="${#lists.isEmpty(cartItems)}" class="cart-empty">
            <div class="empty-cart-icon">üõçÔ∏è</div>
            <h2>Gi·ªè h√†ng tr·ªëng</h2>
            <p>H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng ƒë·ªÉ ti·∫øp t·ª•c mua s·∫Øm</p>
            <a th:href="@{/products}" class="btn-primary">Kh√°m ph√° s·∫£n ph·∫©m</a>
        </div>

        
        <div th:if="${!#lists.isEmpty(cartItems)}" class="cart-content">
            <div class="cart-items">
                <div th:each="item : ${cartItems}" class="cart-item" th:data-item-id="${item.cartItemId}" style="display: flex; gap: 1rem; align-items: center;">
                    <!-- Checkbox -->
                    <div style="padding: 0 0.5rem;">
                        <input type="checkbox" class="cart-item-check form-check-input" 
                               style="width: 1.25rem; height: 1.25rem; cursor: pointer;"
                               th:value="${item.cartItemId}"
                               th:disabled="${item.productType.quantity <= 0}"
                               onchange="updateCartTotal()">
                    </div>

                    <div class="cart-item-content" style="flex: 1; display: flex; gap: 1.5rem; align-items: center;"
                         th:classappend="${item.productType.quantity <= 0 ? 'opacity-50' : ''}">
                        
                        <div class="cart-item-image" style="position: relative;">
                            <img th:if="${!#lists.isEmpty(item.productType.product.productImages)}" 
                                 th:src="${#strings.startsWith(item.productType.product.productImages[0].productImage, 'http') ? item.productType.product.productImages[0].productImage : '/' + item.productType.product.productImages[0].productImage}" 
                                 th:alt="${item.productType.product.name}">
                            <div th:if="${#lists.isEmpty(item.productType.product.productImages)}" 
                                 class="cart-item-placeholder">
                                ü™ë
                            </div>
                            <span th:if="${item.productType.quantity <= 0}" 
                                  style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap;">H·∫øt h√†ng</span>
                        </div>
                        
                        <div class="cart-item-details" style="flex: 2;">
                            <h3 th:text="${item.productType.product.name}">T√™n s·∫£n ph·∫©m</h3>
                            <p class="cart-item-variant">
                                <span th:text="${item.productType.color}">M√†u</span>
                                <span th:if="${item.productType.material != null}"> - <span th:text="${item.productType.material}">Ch·∫•t li·ªáu</span></span>
                            </p>
                            <p class="cart-item-price" th:data-price="${item.price}">
                                <span th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}">0</span> VNƒê
                            </p>
                            <p th:if="${item.productType.quantity <= 0}" class="text-danger fw-bold small">M·∫∑t h√†ng ƒë√£ h·∫øt</p>
                        </div>
                        
                        <div class="cart-item-actions" style="flex: 1;">
                            <div class="quantity-selector">
                                <button class="qty-btn qty-minus" th:onclick="'updateQuantity(' + ${item.cartItemId} + ', ' + ${item.quantity - 1} + ')'"
                                        th:disabled="${item.productType.quantity <= 0}">-</button>
                                <input type="number" 
                                       class="qty-input" 
                                       th:value="${item.quantity}" 
                                       min="1" 
                                       readonly>
                                <button class="qty-btn qty-plus" th:onclick="'updateQuantity(' + ${item.cartItemId} + ', ' + ${item.quantity + 1} + ')'"
                                        th:disabled="${item.productType.quantity <= 0}">+</button>
                            </div>
                            
                            <p class="cart-item-subtotal">
                                <span th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 'COMMA', 0, 'POINT')}">0</span> VNƒê
                            </p>
                            
                            <button class="cart-item-remove" th:onclick="'removeItem(' + ${item.cartItemId} + ')'">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="cart-summary">
                <h3>T·ªïng ƒê∆°n H√†ng</h3>
                
                <div class="summary-row">
                    <span>T·∫°m t√≠nh (ƒë√£ ch·ªçn):</span>
                    <span class="cart-subtotal">0 VNƒê</span>
                </div>
                
                <div class="summary-row">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span>Mi·ªÖn ph√≠</span>
                </div>

                <div class="summary-divider"></div>
                
                <div class="summary-row summary-total">
                    <span>T·ªïng c·ªông:</span>
                    <span class="cart-total">0 VNƒê</span>
                </div>
                
                <button onclick="proceedToCheckout()" class="btn-checkout" style="width: 100%; border: none; cursor: pointer;">Ti·∫øn h√†nh thanh to√°n</button>
                <a th:href="@{/products}" class="btn-continue">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <p>&copy; 2026 Ergoffice. All rights reserved.</p>
    </div>
</footer>

<div th:replace="~{fragments/navigation :: user-menu-scripts}"></div>

<script>
// Format currency
const formatter = new Intl.NumberFormat('vi-VN');

function updateCartTotal() {
    let total = 0;
    const checkboxes = document.querySelectorAll('.cart-item-check');
    let hasItems = false;
    
    checkboxes.forEach(chk => {
        if (chk.checked && !chk.disabled) {
            hasItems = true;
            let itemId = chk.value;
            let row = chk.closest('.cart-item');
            // Get price from data attribute
            let priceText = row.querySelector('.cart-item-price').getAttribute('data-price');
            let price = parseFloat(priceText);
            let qty = parseInt(row.querySelector('.qty-input').value);
            total += price * qty;
        }
    });

    // Update displays
    const totalStr = formatter.format(total) + ' VNƒê';
    document.querySelector('.cart-subtotal').textContent = totalStr;
    document.querySelector('.cart-total').textContent = totalStr;
}

function proceedToCheckout() {
    let selected = [];
    document.querySelectorAll('.cart-item-check:checked').forEach(chk => {
        if (!chk.disabled) {
            selected.push(chk.value);
        }
    });
    
    if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n');
        return;
    }
    
    const voucherInput = document.getElementById('voucherCode');
    const voucherCode = voucherInput ? voucherInput.value.trim() : '';
    
    let url = '/checkout?items=' + selected.join(',');
    if (voucherCode) {
        url += '&voucherCode=' + encodeURIComponent(voucherCode);
    }
    
    window.location.href = url;
}

// Update quantity
async function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;
    
    try {
        const response = await fetch(`/cart/update/${itemId}?quantity=${newQuantity}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload(); 
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t gi·ªè h√†ng');
    }
}

// Remove item
async function removeItem(itemId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;
    
    try {
        const response = await fetch(`/cart/remove/${itemId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a s·∫£n ph·∫©m');
    }
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    updateCartTotal();
});
</script>

</body>
</html>

