<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - Ergoffice'">Product - Ergoffice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <div th:replace="~{fragments/navigation :: user-menu-styles}"></div>
    <style>
        .product-variant-selector {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: var(--radius-md);
            border: 1px solid #e9ecef;
        }
        
        .variant-option {
            margin-bottom: 1rem;
        }
        
        .variant-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--text-main);
        }
        
        .btn-add-cart {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }
        
        .btn-add-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
            background: var(--primary-dark);
        }
        
        .btn-add-cart:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .price-tag {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin: 1rem 0;
            display: block;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stock-status {
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        
        .in-stock { color: #10b981; }
        .out-of-stock { color: #ef4444; }
    </style>
</head>
<body>

<div th:replace="~{fragments/navigation :: navigation}"></div>

<div class="container" style="padding-top: 2rem; padding-bottom: 4rem;">
    <div class="product-detail">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem;">
            
            <div>
                <div class="main-image" style="margin-bottom: 1rem; position: relative; overflow: hidden; border-radius: 20px;">
                    <img th:if="${!#lists.isEmpty(product.productImages)}" 
                         th:src="${#strings.startsWith(product.productImages[0].productImage, 'http') ? product.productImages[0].productImage : '/' + product.productImages[0].productImage}" 
                         th:alt="${product.name}"
                         id="mainImage"
                         style="width: 100%; height: 500px; object-fit: cover; transition: transform 0.3s ease;">
                    <div th:if="${#lists.isEmpty(product.productImages)}" 
                         style="width: 100%; height: 500px; background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%); display: flex; align-items: center; justify-content: center; color: #a5b4fc; font-size: 6rem;">
                        üì∑
                    </div>
                </div>
                
                
                <div th:if="${#lists.size(product.productImages) > 1}" 
                     style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1rem;">
                    <img th:each="image : ${product.productImages}" 
                         th:src="${#strings.startsWith(image.productImage, 'http') ? image.productImage : '/' + image.productImage}" 
                         th:alt="${product.name}"
                         onclick="document.getElementById('mainImage').src = this.src"
                         style="width: 100%; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                         onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='scale(1.05)'"
                         onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
                </div>
            </div>
            
            
            <div>
                <div style="margin-bottom: 1rem;">
                    <span style="background: #eff6ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">New Arrival</span>
                </div>
                
                <h1 th:text="${product.name}" style="margin-bottom: 1rem; font-size: 2.5rem; line-height: 1.2;">Product Name</h1>
                
                
                <span class="price-tag" id="displayPrice">
                    <span th:if="${!#lists.isEmpty(product.productTypes)}" 
                          th:text="${#numbers.formatDecimal(product.productTypes[0].price, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">0 VNƒê</span>
                    <span th:if="${#lists.isEmpty(product.productTypes)}">Li√™n h·ªá</span>
                </span>
                
                <p class="description" th:text="${product.descript}" style="font-size: 1.1rem; line-height: 1.7; color: var(--text-muted); margin-bottom: 2rem;">
                    Description
                </p>
                
                
                <div th:if="${!#lists.isEmpty(product.productTypes)}" class="product-variant-selector">
                    <div class="variant-option">
                        <label class="variant-label">Phi√™n b·∫£n (M√†u s·∫Øc / K√≠ch th∆∞·ªõc):</label>
                        <select id="variantSelect" class="form-control" onchange="updatePrice()" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db;">
                            <option th:each="type : ${product.productTypes}"
                                    th:value="${type.typeId}"
                                    th:data-price="${type.price}"
                                    th:data-stock="${type.quantity}"
                                    th:text="${type.color} + (${type.material} != null ? ' - ' + ${type.material} : '')">
                                Variant
                            </option>
                        </select>
                        <div id="stockStatus" class="stock-status in-stock">
                            C√≤n h√†ng
                        </div>
                    </div>
                    
                    <div class="variant-option">
                        <label class="variant-label">S·ªë l∆∞·ª£ng:</label>
                        <div class="quantity-selector" style="background: white; border: 1px solid #d1d5db; display: inline-flex;">
                            <button class="qty-btn" onclick="updateDetailQuantity(-1)" style="width: 40px; height: 40px;">-</button>
                            <input type="number" id="quantityInput" value="1" min="1" max="100" class="qty-input" style="width: 60px;">
                            <button class="qty-btn" onclick="updateDetailQuantity(1)" style="width: 40px; height: 40px;">+</button>
                        </div>
                    </div>
                    
                    <button class="btn-add-cart" onclick="addToCartFromDetail()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <path d="M16 10a4 4 0 0 1-8 0"/>
                        </svg>
                        Th√™m v√†o gi·ªè h√†ng
                    </button>

                    <!-- Wishlist button -->
                    <div style="margin-top: 1rem;">

                        <!-- Ch∆∞a ƒëƒÉng nh·∫≠p -->
                        <div sec:authorize="!isAuthenticated()">
                            <a th:href="@{/login}"
                               class="btn btn-outline-danger"
                               style="width: 100%; border-radius: 50px; padding: 0.8rem; font-weight: 600;">
                                ü§ç ƒêƒÉng nh·∫≠p ƒë·ªÉ y√™u th√≠ch
                            </a>
                        </div>

                        <!-- ƒê√£ ƒëƒÉng nh·∫≠p -->
                        <div sec:authorize="isAuthenticated()">

                            <!-- Ch∆∞a c√≥ trong wishlist -->
                            <form th:if="${!inWishlist}"
                                  th:action="@{/wishlist/add}"
                                  method="post">
                                <input type="hidden" name="productId" th:value="${product.productId}">
                                <button type="submit"
                                        class="btn btn-outline-danger"
                                        style="width: 100%; border-radius: 50px; padding: 0.8rem; font-weight: 600;">
                                    ü§ç Th√™m v√†o y√™u th√≠ch
                                </button>
                            </form>

                            <!-- ƒê√£ c√≥ trong wishlist -->
                            <form th:if="${inWishlist}"
                                  th:action="@{/wishlist/remove}"
                                  method="post">
                                <input type="hidden" name="productId" th:value="${product.productId}">
                                <button type="submit"
                                        class="btn btn-danger"
                                        style="width: 100%; border-radius: 50px; padding: 0.8rem; font-weight: 600;">
                                    ‚ù§Ô∏è ƒê√£ y√™u th√≠ch
                                </button>
                            </form>

                        </div>
                    </div>

                </div>
                
                <div th:if="${#lists.isEmpty(product.productTypes)}" class="alert alert-warning">
                    S·∫£n ph·∫©m n√†y hi·ªán ƒëang h·∫øt h√†ng ho·∫∑c ch∆∞a c√≥ phi√™n b·∫£n.
                </div>
                
                
                <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        B·∫£o h√†nh ch√≠nh h√£ng 12 th√°ng
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                        Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn to√†n qu·ªëc
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                        Cam k·∫øt ch·∫•t l∆∞·ª£ng 100%
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        ƒê·ªïi tr·∫£ trong 7 ng√†y
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    <div class="related-products" th:if="${!#lists.isEmpty(relatedProducts)}" style="margin-top: 4rem;">
        <h3 style="font-weight: 700; margin-bottom: 2rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 1rem;">S·∫£n ph·∫©m li√™n quan</h3>
        <div style="display: flex; gap: 1.5rem; overflow-x: auto; padding-bottom: 1rem; scroll-behavior: smooth;">
            <div th:each="related : ${relatedProducts}" style="min-width: 280px; flex-shrink: 0;">
                <div class="card h-100 border-0 shadow-sm" style="border-radius: 15px; overflow: hidden; transition: transform 0.3s;">
                    <a th:href="@{'/product/' + ${related.productId}}">
                        <img th:if="${!#lists.isEmpty(related.productImages)}"
                             th:src="${#strings.startsWith(related.productImages[0].productImage, 'http') ? related.productImages[0].productImage : '/' + related.productImages[0].productImage}"
                             class="card-img-top" style="height: 200px; object-fit: cover;">
                         <div th:if="${#lists.isEmpty(related.productImages)}" 
                              style="height: 200px; background: #eee; display: flex; align-items: center; justify-content: center;">üì∑</div>
                    </a>
                    <div class="card-body">
                        <h5 class="card-title" style="font-size: 1rem;">
                            <a th:href="@{'/product/' + ${related.productId}}" th:text="${related.name}" style="text-decoration: none; color: inherit;">Name</a>
                        </h5>
                        <p class="card-text fw-bold text-primary" th:if="${!#lists.isEmpty(related.productTypes)}" 
                           th:text="${#numbers.formatDecimal(related.productTypes[0].price, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">Price</p>
                    </div>
                </div>
            </div>
        </div>
        <style>
            .related-products > div::-webkit-scrollbar {
                height: 8px;
            }
            .related-products > div::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            .related-products > div::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }
            .related-products > div::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            .related-products .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
            }
        </style>
    </div>

    <!-- Reviews Section -->
    <div class="product-reviews" style="margin-top: 4rem;">
        <h3 style="font-weight: 700; margin-bottom: 2rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 1rem;">ƒê√°nh gi√° kh√°ch h√†ng</h3>
        
        <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-5" style="background: #f8f9fa; border-radius: 10px;">
            <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho s·∫£n ph·∫©m n√†y.</p>
        </div>

        <div th:each="review : ${reviews}" class="review-item" style="margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-3">
                    <div style="width: 40px; height: 40px; background: #e0e7ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold;">
                        <span th:text="${#strings.substring(review.customer.name, 0, 1)}">U</span>
                    </div>
                    <div>
                        <div class="fw-bold" th:text="${review.customer.name}">User Name</div>
                        <div class="text-warning" style="font-size: 0.9rem;">
                            <span th:each="i : ${#numbers.sequence(1, 5)}">
                                <i th:class="${i <= review.rating} ? 'fas fa-star' : 'far fa-star'"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="text-muted" style="font-size: 0.85rem;" th:text="${#calendars.format(review.createAt, 'dd/MM/yyyy')}">Date</div>
            </div>
            <p class="review-content" th:text="${review.content}" style="color: #4b5563; padding-left: 3.5rem;">Good product!</p>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <p>&copy; 2026 Ergoffice. All rights reserved.</p>
    </div>
</footer>

<div th:replace="~{fragments/navigation :: user-menu-scripts}"></div>
<script th:src="@{/js/cart.js}"></script>

<script>
    function updatePrice() {
        const select = document.getElementById('variantSelect');
        if (!select) return;
        
        const option = select.options[select.selectedIndex];
        const price = parseFloat(option.getAttribute('data-price'));
        const stock = parseInt(option.getAttribute('data-stock'));
        
        // Format price
        const formattedPrice = new Intl.NumberFormat('vi-VN').format(price) + ' VNƒê';
        document.getElementById('displayPrice').textContent = formattedPrice;
        
        // Update stock status
        const stockStatus = document.getElementById('stockStatus');
        const addBtn = document.querySelector('.btn-add-cart');
        
        if (stock > 0) {
            stockStatus.textContent = `C√≤n h√†ng (${stock} s·∫£n ph·∫©m)`;
            stockStatus.className = 'stock-status in-stock';
            addBtn.disabled = false;
            addBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
                Th√™m v√†o gi·ªè h√†ng
            `;
            // Update max quantity input
            document.getElementById('quantityInput').max = stock;
        } else {
            stockStatus.textContent = 'H·∫øt h√†ng';
            stockStatus.className = 'stock-status out-of-stock';
            addBtn.disabled = true;
            addBtn.textContent = 'H·∫øt h√†ng';
        }
    }
    
    function updateDetailQuantity(change) {
        const input = document.getElementById('quantityInput');
        let val = parseInt(input.value) + change;
        
        // Check min/max
        const max = parseInt(input.max) || 100;
        if (val < 1) val = 1;
        if (val > max) val = max;
        
        input.value = val;
    }
    
    function addToCartFromDetail() {
        const select = document.getElementById('variantSelect');
        if (!select) return;
        
        const typeId = select.value;
        const quantity = document.getElementById('quantityInput').value;
        const addBtn = document.querySelector('.btn-add-cart');
        
        // Show loading state
        const originalText = addBtn.innerHTML;
        addBtn.disabled = true;
        addBtn.textContent = 'ƒêang th√™m...';
        
        // Call Cart JS function
        addToCart(typeId, quantity).then(() => {
            // Restore button after delay
            setTimeout(() => {
                addBtn.disabled = false;
                addBtn.innerHTML = originalText;
            }, 1000);
        });
    }
    
    // Initialize price on load
    document.addEventListener('DOMContentLoaded', updatePrice);
</script>

</body>
</html>

